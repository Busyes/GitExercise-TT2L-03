<!DOCTYPE html>
<html>
  <head>
    <title>POMOZONE</title>
  </head>


  <head>
    <link rel="stylesheet" href="static/style.css">
    <audio id="alarm-music" src="static/sound/alarm 1.mp3" loop></audio>
</head>
<body>
    <nav class="navbar">
        <div class="navdiv">
            <div class="logo"><a href="/index" class="logo"><img src="{{ url_for('send_static', logo='images/logo.png') }}" alt="jomPOMO logo"> </a> </div>
                <ul>
                    <li><a href="/timer">POMOZONE</a></li>
                    <li>
                        <a href="#">LIBRARY</a>
                        <ul class="dropdown">
                            <li><a href="#">Background image</a> </li>
                            <li><a href="/sound">Sound</a> </li>
                            <li><a href="/alarm">Alarm</a> </li>
                        </ul>
                    </li>
                    <li><a href="#">TRACK</a></li>
                    <li><a href="#">ABOUT</a></li>
                    <button><a href="/login">LOG IN</a></button>
                    <button><a href="/sign_up">SIGN UP</a></button>
                </ul>


        </div>




    </nav>
    

  <body>
    <h1>POMOZONE</h1>
    <button id="start-button">Start</button>
    <button id="stop-button" disabled>Stop</button>
    <button id="reset-button" disabled>Reset</button>
    <div id="timer">
      <span id="work-time">25:00</span>
      <span id="separator">/</span>
      <span id="break-time">05:00</span>
    </div>
  
      <button id="skipbreak-button">Skip Break</button>

    </div>

    <script>
      function storeUserSession(sessionData) {
        fetch('/store-session', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(sessionData),
        })
        .then((response) => response.json())
        .then((data) => {
          console.log('Success:', data);
        })
        .catch((error) => {
          console.error('Error:', error);
        });
      }

      const startButton = document.getElementById("start-button");
      const stopButton = document.getElementById("stop-button");
      const resetButton = document.getElementById("reset-button");
      const timer = document.getElementById("timer");
      const workTime = document.getElementById("work-time");
      const breakTime = document.getElementById("break-time");
      const skipbreakButton = document.getElementById("skipbreak-button");
      const Alarm = document.getElementById("alarm-music");

      // 25 minutes --> 5 minutes --> 25 minutes = 1 session
      let workInterval;
      let breakInterval;
      let timeLeft = 5; // 25 minutes in seconds
      let breakTimeLeft = 5 * 60; // 5 minutes in seconds
      let isWorking = true;
      let sessionId = null;

      startButton.addEventListener("click", () => {
        startButton.disabled = true;
        stopButton.disabled = false;
        resetButton.disabled = false;
        if (isWorking) {
          workInterval = setInterval(() => {
            timeLeft--;
            workTime.textContent = `${Math.floor(timeLeft / 60)}:${(timeLeft % 60).toString().padStart(2, "0")}`;
            if (timeLeft === 0) {
              clearInterval(workInterval);
              isWorking = false;
              breakTimeLeft = breakTimeLeft;

              breakInterval = setInterval(() => {
                breakTimeLeft--;
                breakTime.textContent = `${Math.floor(breakTimeLeft / 60)}:${(breakTimeLeft % 60).toString().padStart(2, "0")}`;
                if (breakTimeLeft === 0) {
                  clearInterval(breakInterval);
                  isWorking = true;
                }
              }, 1000);
            }
          }, 1000);
        } else {
          breakInterval = setInterval(() => {
            breakTimeLeft--;
            breakTime.textContent = `${Math.floor(breakTimeLeft / 60)}:${(breakTimeLeft % 60).toString().padStart(2, "0")}`;
            if (breakTimeLeft === 0) {
              clearInterval(breakInterval);
              isWorking = true;
              timeLeft = 25 * 60;
              workInterval = setInterval(() => {
                timeLeft--;
                workTime.textContent = `${Math.floor(timeLeft / 60)}:${(timeLeft % 60).toString().padStart(2, "0")}`;
                if (timeLeft === 0) {
                  clearInterval(workInterval);
                  isWorking = false;
                }
              }, 1000);
            }
          }, 1000);
        }
      });

      stopButton.addEventListener("click", () => {
        startButton.disabled = false;
        stopButton.disabled = true;
        clearInterval(workInterval);
        clearInterval(breakInterval);
      });

      resetButton.addEventListener("click", () => {
        startButton.disabled = false;
        stopButton.disabled = true;
        resetButton.disabled = true;
        clearInterval(workInterval);
        clearInterval(breakInterval);

        timeLeft = 5;

        breakTimeLeft = 5 * 60;
        workTime.textContent = "25:00";
        breakTime.textContent = "05:00";
        isWorking = true;
        skipbreakButton.disabled = false;
        Alarm.pause();
      });

    skipbreakButton.addEventListener("click", () => {
      if (breakInterval) {
      clearInterval(breakInterval);
      isWorking = true;
      timeLeft = 5;
      breakTimeLeft = 5 * 60;
      workInterval = setInterval(() => { 
        timeLeft--;
        workTime.textContent = `${Math.floor(timeLeft / 60)}:${(timeLeft % 60).toString().padStart(2, "0")}`; 
        if (timeLeft === 0) { 
          clearInterval(workInterval); 
          isWorking = false; 

          {% if current_user.is_authenticated %}
          const sessionData = {
            user_id: {{ current_user.id }},
          };
          storeUserSession(sessionData);
          {% endif %}

          // Alarm.play(); 
          // Alarm.currentTime = 0; 
          alert("Timer is up!");
          resetTimer();
        } 
      }, 1000);
      skipbreakButton.disabled = true;
        }
      });

      updateTimerDisplay(); // Initial display update
      
      </script>
    